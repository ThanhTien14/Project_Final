<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Sản Phẩm</title>
    <link rel="stylesheet" href="/stylesheets/list-products.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <div class="top-bar">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Tìm kiếm sản phẩm...">
            <button id="search-button"><i class="fas fa-search"></i></button>
        </div>
        <button class="filter-button" id="sort-button" data-sort-order="desc">
            <i class="fas fa-filter"></i>
        </button>
    </div>
 
    <div>   
    <div class="filter-container">
        <label for="product-type">Loại sản phẩm:</label>
        <select id="product-type" class="filter-select">
            <option value="">Tất cả</option>
            <option value="BDN">BDN</option>
            <option value="HSTK">Hỗ trợ sức khỏe</option>
            <option value="Khoáng chất">Khoáng chất</option>
            <option value="LĐ">Làm đẹp</option>
        </select>

        <label for="min-price">Giá từ:</label>
        <input type="number" id="min-price" class="price-input" placeholder="Nhập giá thấp nhất">

        <label for="max-price">Đến:</label>
        <input type="number" id="max-price" class="price-input" placeholder="Nhập giá cao nhất">

        <label for="search-logic">Tìm OR:</label>
        <input type="checkbox" id="search-logic" value="OR">

        <button id="filter-button" class="apply-filter-button">Lọc</button>
    </div>
    </div>
    <div class="container">
        <main class="main-content">
            <ul class="product-list">
                </ul>
        </main>
    </div>
    <div class="pagination">
        <button class="pagination-button" id="prev-page" disabled>&laquo; Trước</button>
        <span id="current-page">1</span> / <span id="total-pages">1</span>
        <button class="pagination-button" id="next-page">&raquo; Sau</button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentPage = 1;
            let totalPages = 1;
            let currentFilters = { sortOrder: 'asc'}; // Lưu filter và sort
    
            function renderProducts(products) {
                const productList = document.querySelector('.product-list');
                productList.innerHTML = products.length ? products.map(product => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('product-item');

                    const imagePlaceholder = document.createElement('div');
                    imagePlaceholder.classList.add('product-image-placeholder');
                    if (product.image_url) {
                        const image = document.createElement('img');
                        image.src = `/${product.image_url}`;
                        image.alt = product.name;
                        imagePlaceholder.appendChild(image);
                    } else {
                        imagePlaceholder.innerHTML = '<i class="fas fa-image"></i>';
                    }

                    const details = document.createElement('div');
                    details.classList.add('product-details');

                    const title = document.createElement('h3');
                    title.textContent = product.name;

                    const price = document.createElement('p');
                    price.classList.add('price');
                    price.textContent = `${product.price.toLocaleString('vi-VN')} VND`;

                    const infoRow = document.createElement('div');
                    infoRow.classList.add('product-info-row');
                    infoRow.innerHTML = `
                    <span class="category">${product.category || 'Không xác định'}</span>
                    <span class="separator"> | </span>
                    <span class="brand">${product.brand || 'Không xác định'}</span>
                    <span class="separator"> | </span>
                    <span class="target-audience">${
                        Array.isArray(product.target_audience)
                        ? product.target_audience.join(', ')
                        : product.target_audience || 'Không xác định'
                    }</span>
                    `;

                    details.appendChild(title);
                    details.appendChild(price);
                    details.appendChild(infoRow);

                    const actions = document.createElement('div');
                    actions.classList.add('product-actions');

                    const quickViewIcon = document.createElement('a');
                    quickViewIcon.classList.add('action-icon', 'quick-view-button');
                    quickViewIcon.href = `/pages/update-product.html?id=${product.id}`;
                    quickViewIcon.innerHTML = '<i class="fas fa-eye"></i>';

                    const deleteIcon = document.createElement('span');
                    deleteIcon.classList.add('action-icon', 'delete-button');
                    deleteIcon.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteIcon.dataset.productId = product.id;

                    actions.appendChild(quickViewIcon);
                    actions.appendChild(deleteIcon);

                    listItem.appendChild(imagePlaceholder);
                    listItem.appendChild(details);
                    listItem.appendChild(actions);

                    return listItem.outerHTML;
                }).join('')
                : '<li>Không tìm thấy sản phẩm</li>';
            }

            async function fetchProducts(page = 1, filters = {}) {
                try {
                    let url = `/api/products?page=${page}&limit=10&sort=price&order=${currentFilters.sortOrder}`;
                    if (currentFilters.search) url += `&name=${encodeURIComponent(currentFilters.search)}`;
                    if (currentFilters.minPrice) url += `&priceFrom=${currentFilters.minPrice}`;
                    if (currentFilters.maxPrice) url += `&priceTo=${currentFilters.maxPrice}`;
                    if (currentFilters.productType) url += `&category=${encodeURIComponent(currentFilters.productType)}`;
                    if (currentFilters.logic) url += `&logic=${currentFilters.logic}`;
                    console.log('Fetching URL:', url); // Debugging URL
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    renderProducts(data.products);
                    totalPages = data.pagination.totalPages;
                    currentPage = data.pagination.currentPage;

                    // Cập nhật phân trang
                    document.getElementById('prev-page').disabled = currentPage === 1;
                    document.getElementById('next-page').disabled = currentPage === totalPages;
                    document.getElementById('current-page').textContent = currentPage;
                    document.getElementById('total-pages').textContent = totalPages;

                    // Cập nhật nút số trang
                    const paginationContainer = document.querySelector('.pagination');
                    const existingPageButtons = paginationContainer.querySelectorAll('.page-number');
                    existingPageButtons.forEach(button => button.remove());
                    for (let i = 1; i <= totalPages; i++) {
                        const pageButton = document.createElement('button');
                        pageButton.classList.add('page-number');
                        pageButton.textContent = i;
                        if (i === currentPage) pageButton.classList.add('active');
                        pageButton.addEventListener('click', () => {
                        currentPage = i;
                        fetchProducts(currentPage);
                        });
                        paginationContainer.insertBefore(pageButton, document.getElementById('next-page'));
                    }
                } catch (error) {
                    console.error('Lỗi khi tải sản phẩm:', error);
                    document.querySelector('.product-list').innerHTML = '<li>Lỗi khi tải sản phẩm</li>';
                }
            }
    
            // Tải dữ liệu sản phẩm từ server
            fetchProducts();
    
            // Tìm kiếm sản phẩm
            document.getElementById('search-button').addEventListener('click', function() {
                const searchInput = document.getElementById('search-input').value;
                currentFilters.search = searchInput || undefined;
                currentPage = 1;
                fetchProducts(currentPage);
            });

            // Xử lý sự kiện xắp xếp sản phẩm theo giá cao/thấpthấp
            document.getElementById('sort-button').addEventListener('click', function() {
                currentFilters.sortOrder = currentFilters.sortOrder === 'asc' ? 'desc' : 'asc';
                this.dataset.sortOrder = currentFilters.sortOrder;
                currentPage = 1;
                fetchProducts(currentPage);
            });
            
            // Xử lý sự kiện lọc giá sản phẩm
            document.getElementById('filter-button').addEventListener('click', function() {
                const minPrice = parseFloat(document.getElementById('min-price').value);
                const maxPrice = parseFloat(document.getElementById('max-price').value);
                const productType = document.getElementById('product-type').value;
                const logic = document.getElementById('search-logic').checked ? 'OR' : undefined;

                if (minPrice < 0 || maxPrice < 0) {
                alert('Giá không được là số âm.');
                return;
                }
                if (minPrice && maxPrice && minPrice > maxPrice) {
                alert('Giá thấp nhất không được lớn hơn giá cao nhất.');
                return;
                }

                currentFilters.minPrice = minPrice || undefined;
                currentFilters.maxPrice = maxPrice || undefined;
                currentFilters.productType = productType || undefined;
                currentFilters.logic = logic;
                currentPage = 1;
                fetchProducts(currentPage);
            });
    
            // Xử lý nút phân trang
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                currentPage--;
                fetchProducts(currentPage);
                }
            });

            document.getElementById('next-page').addEventListener('click', function() {
                if (currentPage < totalPages) {
                currentPage++;
                fetchProducts(currentPage);
                }
            });
        });
    </script>
</body>
</html>