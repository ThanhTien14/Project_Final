<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Sản Phẩm</title>
    <link rel="stylesheet" href="../stylesheets/list-products.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <div class="top-bar">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Tìm kiếm sản phẩm...">
            <button id="search-button"><i class="fas fa-search"></i></button>
        </div>
        <button class="filter-button" id="sort-button" data-sort-order="desc">
            <i class="fas fa-filter"></i>
        </button>
    </div>
 
    <div>   
    <div class="filter-container">
        <label for="product-type">Loại sản phẩm:</label>
        <select id="product-type" class="filter-select">
            <option value="">Tất cả</option>
            <option value="BDN">BDN</option>
            <option value="HSTK">Hỗ trợ sức khỏe</option>
            <option value="Khoáng chất">Khoáng chất</option>
            <option value="LD">Làm đẹp</option>
        </select>

        <label for="min-price">Giá từ:</label>
        <input type="number" id="min-price" class="price-input" placeholder="Nhập giá thấp nhất">

        <label for="max-price">Đến:</label>
        <input type="number" id="max-price" class="price-input" placeholder="Nhập giá cao nhất">

        <button id="filter-button" class="apply-filter-button">Lọc</button>
    </div>
    </div>
    <div class="container">
        <main class="main-content">
            <ul class="product-list">
                </ul>
        </main>
    </div>
    <div class="pagination">
        <button class="pagination-button" id="prev-page" disabled>&laquo; Trước</button>
        <span id="current-page">1</span> / <span id="total-pages">1</span>
        <button class="pagination-button" id="next-page">&raquo; Sau</button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentPage = 1;
            const itemsPerPage = 10;
            let totalPages = 1;
            let allProducts = [];
            let currentProducts = [];
    
            function renderProducts(products) {
                const productList = document.querySelector('.product-list');
                productList.innerHTML = products.length
                ? products.map(product => {

                    products.forEach(product => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('product-item');
      
                    const imagePlaceholder = document.createElement('div');
                    imagePlaceholder.classList.add('product-image-placeholder');
                    if (product.image_url) {
                        const image = document.createElement('img');
                        image.src = `/${product.image_url}`;
                        image.alt = product.name;
                        imagePlaceholder.appendChild(image);
                    } else {
                        imagePlaceholder.innerHTML = '<i class="fas fa-image"></i>';
                        imagePlaceholder.innerHTML = '<i class="fas fa-image"></i>';
                    }
    
                    const details = document.createElement('div');
                    details.classList.add('product-details');
    
                    const title = document.createElement('h3');
                     title.textContent = product.name;

                    const price = document.createElement('p');
                    price.classList.add('price');
                    price.textContent = `${product.price.toLocaleString('vi-VN')} VND`;

                    // Create a container for category, brand, and target-audience
                    const infoRow = document.createElement('div');
                    infoRow.classList.add('product-info-row');
                    infoRow.innerHTML = `
                    <span class="category">${product.category || 'Không xác định'}</span>
                    <span class="separator"> | </span>
                    <span class="brand">${product.brand || 'Không xác định'}</span>
                    <span class="separator"> | </span>
                    <span class="target-audience">${product.target_audience?.join(', ') || 'Không xác định'}</span>
                    `;

                     details.appendChild(title);
                     details.appendChild(price);
                     details.appendChild(infoRow);

                    const actions = document.createElement('div');
                    actions.classList.add('product-actions');
    
                    const quickViewIcon = document.createElement('a');
                    quickViewIcon.classList.add('action-icon', 'quick-view-button');
                    quickViewIcon.href = `/pages/update-product.html?id=${product.id}`;
                    quickViewIcon.innerHTML = '<i class="fas fa-eye"></i>';
    
                    quickViewIcon.href = `/pages/update-product.html?id=${product.id}`;
                    quickViewIcon.innerHTML = '<i class="fas fa-eye"></i>';
    
                    const deleteIcon = document.createElement('span');
                    deleteIcon.classList.add('action-icon', 'delete-button');
                    deleteIcon.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteIcon.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteIcon.dataset.productId = product.id;
    
                    actions.appendChild(quickViewIcon);
                    actions.appendChild(deleteIcon);
    
                    listItem.appendChild(imagePlaceholder);
                    listItem.appendChild(details);
                    listItem.appendChild(actions);
    
                    productList.appendChild(listItem);
                    });

                    return `<li class="product-item">...</li>`;
                }).join('')
                : '<li>Không tìm thấy sản phẩm</li>';
            }
    
            // xử lý phân trang sản phẩm.
            function renderPagination() {
                const startIndex = (currentPage - 1) * itemsPerPage;// Tính vị trí bắt đầu lấy sản phẩm cho trang hiện tại (bắt đầu từ 0).
                const endIndex = startIndex + itemsPerPage;// Tính vị trí kết thúc
                const productsToShow = currentProducts.slice(startIndex, endIndex);//Cắt danh sách allProducts từ startIndex đến endIndex → ra các sản phẩm sẽ hiển thị.
                renderProducts(productsToShow);// Render (vẽ) các sản phẩm vừa cắt ra lên giao diện.

                document.getElementById('prev-page').disabled = currentPage === 1;
                document.getElementById('next-page').disabled = currentPage === totalPages;
                document.getElementById('current-page').textContent = currentPage;
                document.getElementById('total-pages').textContent = totalPages;

                // Tự động hiển thị số trang
                const paginationContainer = document.querySelector('.pagination');
                const totalPagesElement = document.getElementById('total-pages');
                const currentPageElement = document.getElementById('current-page');

                totalPagesElement.textContent = totalPages;
                currentPageElement.textContent = currentPage;

                // Xóa các nút trang cũ (nếu có)
                const existingPageButtons = paginationContainer.querySelectorAll('.page-number');
                existingPageButtons.forEach(button => button.remove());

                // Tạo các nút trang mới
                for (let i = 1; i <= totalPages; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.classList.add('page-number');
                    pageButton.textContent = i;
                    if (i === currentPage) {
                        pageButton.classList.add('active');
                    }
                    pageButton.addEventListener('click', function () {
                        currentPage = i;
                        renderPagination();
                    });
                    paginationContainer.insertBefore(pageButton, document.getElementById('next-page'));
                }
            }
    
            // Tải dữ liệu sản phẩm từ server
            fetch('/api/products')
            .then(response => response.json())
            .then(products => {
                allProducts = products;
                currentProducts = allProducts;
                totalPages = Math.ceil(allProducts.length / itemsPerPage);
                renderPagination();
            })
            .catch(error => console.error('Lỗi khi tải sản phẩm:', error));
    
            // Tìm kiếm sản phẩm
            document.getElementById('search-button').addEventListener('click', function() {
                const searchInput = document.getElementById('search-input').value;
                currentPage = 1;
                fetchProducts(1, { search: searchInput });
            });

        
            // Xử lý sự kiện xắp xếp sản phẩm theo giá cao/thấpthấp
            document.getElementById('sort-button').addEventListener('click', function() {
                const sortButton = this;
                const currentOrder = sortButton.dataset.sortOrder;
                const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
                sortButton.dataset.sortOrder = newOrder;

                currentProducts.sort((a, b) => {
                return newOrder === 'desc' ? b.price - a.price : a.price - b.price;
                });
                currentPage = 1;
                renderPagination();
            });

            // Xử lý sự kiện lọc giá sản phẩm
            document.getElementById('filter-button').addEventListener('click', function() {
                const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
                const maxPrice = parseFloat(document.getElementById('max-price').value) || Infinity;
                const productType = document.getElementById('product-type').value;
                if (minPrice < 0 || maxPrice < 0) {
                    alert('Giá không được là số âm.');
                    return;
                }
                if (minPrice > maxPrice) {
                    alert('Giá thấp nhất không được lớn hơn giá cao nhất.');
                    return;
                }
                currentPage = 1;
                fetchProducts(1, { minPrice, maxPrice, productType });    
            });
    
            // Xử lý nút phân trang
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    renderPagination();
                }
            });
    
            document.getElementById('next-page').addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPagination();
                }
            });
        });
    </script>
</body>
</html>