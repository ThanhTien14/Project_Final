<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delete Product</title>
    <link rel="stylesheet" href="/stylesheets/delete-product.css">
</head>
<body>
    <h1>Delete Products</h1>
    
    <!-- Search Form -->
    <div class="search-form">
        <label for="productId">Product ID:</label>
        <input type="text" id="productId" name="productId" placeholder="e.g., TPCN1234">
        <label for="productName">Product Name:</label>
        <input type="text" id="productName" name="productName" placeholder="Enter product name">
        <button type="button" onclick="searchProducts()">Search</button>
        <button type="button" onclick="resetSearch()">Reset</button>
    </div>

    <!-- Product Table -->
    <table>
        <thead>
            <tr>
                <th>Product ID</th>
                <th>Product Name</th>
                <th>Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="productTable">
            <!-- Product data will be inserted here -->
        </tbody>
    </table>
    <button id="deleteAllBtn">Delete All</button>
    <div id="message"></div>

    <script>
        // Function to display message
        function showMessage(message, color) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = message;
            messageElement.style.color = color;
        }

        // Fetch and display products based on search criteria
        async function loadProducts(criteria = {}) {
            try {
                const query = new URLSearchParams(criteria).toString();
                const response = await fetch(`/api/products?${query}`);
                const products = await response.json();
                const productTable = document.getElementById('productTable');
                productTable.innerHTML = '';

                if (products.length === 0) {
                    productTable.innerHTML = '<tr><td colspan="4">No products found</td></tr>';
                    return;
                }

                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>${product.name}</td>
                        <td>${product.price.toLocaleString()} ${product.currency || 'VND'}</td>
                        <td><a href="#" class="delete-link" data-id="${product.id}">Delete</a></td>
                    `;
                    productTable.appendChild(row);
                });

                // Add event listeners for delete links
                document.querySelectorAll('.delete-link').forEach(link => {
                    link.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const productId = e.target.getAttribute('data-id');
                        if (confirm(`Are you sure you want to delete this product?`)) {
                            try {
                                const response = await fetch(`/api/products/${productId}`, {
                                    method: 'DELETE'
                                });
                                const result = await response.json();
                                if (response.ok) {
                                    alert(result.message);
                                    window.location.reload();
                                } else {
                                    showMessage(result.error || 'Failed to delete product', 'red');
                                }
                            } catch (error) {
                                showMessage('Error deleting product', 'red');
                            }
                        }
                    });
                });
            } catch (error) {
                showMessage('Error loading products', 'red');
            }
        }

        // Search products based on form input
        function searchProducts() {
            const productId = document.getElementById('productId').value.trim();
            const productName = document.getElementById('productName').value.trim();
            const criteria = {};

            if (productId) {
                criteria.id = productId;
            }
            if (productName) {
                criteria.name = productName;
            }

            loadProducts(criteria);
        }

        // Reset search form and reload all products
        function resetSearch() {
            document.getElementById('productId').value = '';
            document.getElementById('productName').value = '';
            loadProducts();
        }

        // Delete all products
        document.getElementById('deleteAllBtn').addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete all products?')) {
                try {
                    const response = await fetch('/api/products', {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message);
                        window.location.reload();
                    } else {
                        showMessage(result.error || 'Failed to delete all products', 'red');
                    }
                } catch (error) {
                    showMessage('Error deleting all products', 'red');
                }
            }
        });

        // Load all products on page load
        window.onload = () => loadProducts();
    </script>
</body>
</html>