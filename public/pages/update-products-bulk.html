<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cập Nhật Nhiều Sản Phẩm</title>
    <link rel="stylesheet" href="/stylesheets/update-products-bulk.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/">Trang chủ</a></li>
                <li><a href="/pages/list-products.html">Danh sách sản phẩm</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h1>Cập Nhật Nhiều Sản Phẩm</h1>
        <div id="error-message" class="message error" style="display: none;"></div>
        <div id="success-message" class="message success" style="display: none;"></div>

        <form id="bulk-update-form">
            <div class="form-group">
                <h3>Chọn sản phẩm để cập nhật</h3>
                <table class="product-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>
                            <th>ID</th>
                            <th>Tên</th>
                            <th>Giá</th>
                            <th>Số lượng tồn kho</th>
                            <th>Danh mục</th>
                            <th>Thương hiệu</th>
                            <th>Dạng bào chế</th>
                        </tr>
                    </thead>
                    <tbody id="product-list"></tbody>
                </table>
            </div>
            <div class="form-group">
                <h3>Thông tin cập nhật</h3>
                <div class="update-field">
                    <label for="price">Giá mới (để trống nếu không thay đổi):</label>
                    <input type="number" id="price" name="price" min="0" step="0.01">
                </div>
                <div class="update-field">
                    <label for="quantity_in_stock">Số lượng tồn kho mới (để trống nếu không thay đổi):</label>
                    <input type="number" id="quantity_in_stock" name="quantity_in_stock" min="0">
                </div>
                <div class="update-field">
                    <label for="category">Danh mục mới (để trống nếu không thay đổi):</label>
                    <select id="category" name="category">
                        <option value="">Không thay đổi</option>
                        <option value="HTSK">HTSK</option>
                        <option value="BDN">BDN</option>
                        <option value="LĐ">LĐ</option>
                        <option value="KHOANGCHAT">KHOANGCHAT</option>
                    </select>
                </div>
                <div class="update-field">
                    <label for="description">Mô tả mới (để trống nếu không thay đổi):</label>
                    <textarea id="description" name="description"></textarea>
                </div>
                <div class="update-field">
                    <label for="brand">Thương hiệu mới (để trống nếu không thay đổi):</label>
                    <input type="text" id="brand" name="brand">
                </div>
                <div class="update-field">
                    <label for="dosage_form">Dạng bào chế mới (để trống nếu không thay đổi):</label>
                    <input type="text" id="dosage_form" name="dosage_form">
                </div>
                <div class="update-field">
                    <label for="ingredients">Thành phần mới (phân tách bằng dấu phẩy, để trống nếu không thay đổi):</label>
                    <input type="text" id="ingredients" name="ingredients" placeholder="Ví dụ: Vitamin C, Kẽm">
                </div>
                <div class="update-field">
                    <label for="benefits">Lợi ích mới (phân tách bằng dấu phẩy, để trống nếu không thay đổi):</label>
                    <input type="text" id="benefits" name="benefits" placeholder="Ví dụ: Tăng đề kháng, Hỗ trợ tiêu hóa">
                </div>
            </div>
            <div class="form-actions">
                <button type="submit">Cập nhật</button>
                <button type="button" onclick="window.location.href='/pages/list-products.html'">Hủy</button>
            </div>
        </form>
    </main>

    <script>
        (function() {
            // Tải danh sách sản phẩm
            async function loadProducts() {
                try {
                    const response = await fetch('/api/products');
                    if (!response.ok) throw new Error('Không thể tải danh sách sản phẩm');
                    const products = await response.json();
                    console.log('Products loaded:', products.length); // Log để kiểm tra danh sách sản phẩm
                    console.log('Sample product:', products[0]); // Log mẫu dữ liệu sản phẩm
                    const productList = document.getElementById('product-list');
                    productList.innerHTML = '';
                    products.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                             <td><input type="checkbox" name="product_ids" value="${product.id}"></td>
                            <td>${product.id}</td>
                            <td>${product.name}</td>
                            <td>${product.price.toLocaleString('vi-VN')} ${product.currency || 'VND'}</td>
                            <td>${product.quantity_in_stock || 0}</td>
                            <td>${product.category || 'Chưa có'}</td>
                            <td>${product.brand || 'Chưa có'}</td>
                            <td>${product.dosage_form || 'Chưa có'}</td>
                        `;
                        productList.appendChild(row);
                    });
                } catch (error) {
                    showError(error.message);
                }
            }
        
            // Xử lý chọn tất cả
            document.getElementById('select-all').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('input[name="product_ids"]');
                checkboxes.forEach(checkbox => checkbox.checked = this.checked);
            });
        
            // Xử lý submit form
            document.getElementById('bulk-update-form').addEventListener('submit', async event => {
                event.preventDefault();
                clearMessages();
        
                console.log('Form submitted'); // Log để kiểm tra sự kiện submit
        
                const confirmed = confirm('Bạn có chắc chắn muốn cập nhật các sản phẩm đã chọn?');
                console.log('Confirm result:', confirmed); // Log để kiểm tra kết quả confirm
        
                if (!confirmed) {
                    console.log('User canceled the update');
                    return;
                }

                const productIds = Array.from(document.querySelectorAll('input[name="product_ids"]:checked')).map(input => input.value);
                console.log('Product IDs selected:', productIds); // Log để kiểm tra productIds
        
                if (productIds.length === 0) {
                    showError('Vui lòng chọn ít nhất một sản phẩm');
                    return;
                }
        
                const updateData = {
                    price: document.getElementById('price').value ? parseFloat(document.getElementById('price').value) : undefined,
                    quantity_in_stock: document.getElementById('quantity_in_stock').value ? parseInt(document.getElementById('quantity_in_stock').value) : undefined,
                    category: document.getElementById('category').value || undefined,
                    description: document.getElementById('description').value || undefined,
                    brand: document.getElementById('brand').value || undefined,
                    dosage_form: document.getElementById('dosage_form').value || undefined,
                    ingredients: document.getElementById('ingredients').value || undefined,
                    benefits: document.getElementById('benefits').value || undefined
                };

                // Xóa các trường không có giá trị
                Object.keys(updateData).forEach(key => {
                    if (updateData[key] === undefined || (typeof updateData[key] === 'string' && updateData[key].trim() === '')) {
                        delete updateData[key];
                    }
                });

                // Validation phía client
                if (Object.keys(updateData).length === 0) {
                    showError('Vui lòng cung cấp ít nhất một thông tin để cập nhật');
                    return;
                }
                if (updateData.price && (isNaN(updateData.price) || updateData.price <= 0)) {
                    showError('Giá phải là số dương');
                    return;
                }
                if (updateData.quantity_in_stock && (isNaN(updateData.quantity_in_stock) || updateData.quantity_in_stock < 0)) {
                    showError('Số lượng tồn kho phải là số không âm');
                    return;
                }
                
                console.log('Request body:', { productIds, updateData }); // Log để kiểm tra dữ liệu gửi đi
        
                try {
                    console.log('Sending fetch request to /api/products/bulk');
                    const response = await fetch('/api/products/bulk', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ productIds, updateData })
                    });
        
                    console.log('Response status:', response.status); // Log để kiểm tra status
                    const result = await response.json();
                    console.log('Response body:', result); // Log để kiểm tra body trả về
        
                    if (!response.ok) {
                        const errorMessage = result.details ? result.details.join(', ') : result.error || 'Lỗi khi cập nhật sản phẩm';
                        console.log('Fetch failed with error:', errorMessage);
                        showError(errorMessage);
                        return;
                    }
        
                    showSuccess(result.message || 'Cập nhật sản phẩm thành công');
                    setTimeout(() => window.location.reload(), 3000);
                } catch (error) {
                    console.error('Fetch error:', error);
                    showError('Đã xảy ra lỗi: ' + error.message);
                }
            });
        
            // Hàm hiển thị lỗi
            function showError(message) {
                const errorDiv = document.getElementById('error-message');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    setTimeout(() => errorDiv.style.display = 'none', 3000);
                }
            }
        
            // Hàm hiển thị thành công
            function showSuccess(message) {
                const successDiv = document.getElementById('success-message');
                if (successDiv) {
                    successDiv.textContent = message;
                    successDiv.style.display = 'block';
                    setTimeout(() => successDiv.style.display = 'none', 3000);
                }
            }
        
            // Xóa thông báo
            function clearMessages() {
                const errorDiv = document.getElementById('error-message');
                const successDiv = document.getElementById('success-message');
                if (errorDiv) errorDiv.style.display = 'none';
                if (successDiv) successDiv.style.display = 'none';
            }
        
            // Tải sản phẩm khi trang được load
            loadProducts();
        })();
    </script>
</body>
</html>