<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chỉnh Sửa Sản Phẩm</title>
    <link rel="stylesheet" href="/stylesheets/update-product.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/">Trang chủ</a></li>
                <li><a href="/pages/list-products.html">Danh sách sản phẩm</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h1>Chỉnh Sửa Sản Phẩm</h1>
        <!-- Thông báo được đặt ở đây nhưng sẽ dùng position: fixed để cố định vị trí -->
        <div id="error-message" class="error" style="display: none;"></div>
        <div id="success-message" class="success" style="display: none;"></div>

        <form id="update-product-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="id">ID:</label>
                <input type="text" id="id" name="id" readonly>
            </div>
            <div class="form-group">
                <label for="name">Tên sản phẩm:</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="description">Mô tả:</label>
                <textarea id="description" name="description"></textarea>
            </div>
            <div class="form-group">
                <label for="category">Danh mục:</label>
                <select id="category" name="category">
                    <option value="">Chọn danh mục</option>
                    <option value="HTSK">HTSK</option>
                    <option value="BON">BON</option>
                    <option value="EDN">EDN</option>
                    <option value="KHOANGCHAT">KHOANGCHAT</option>
                </select>
            </div>
            <div class="form-group">
                <label for="brand">Thương hiệu:</label>
                <input type="text" id="brand" name="brand">
            </div>
            <div class="form-group">
                <label for="dosage_form">Dạng bào chế:</label>
                <input type="text" id="dosage_form" name="dosage_form">
            </div>
            <div class="form-group">
                <label>Hình ảnh hiện tại:</label>
                <div id="current-image" class="image-preview">
                    <img src="" alt="Hình ảnh hiện tại" style="display: none;" id="current-image-img">
                </div>
            </div>
            <div class="form-group">
                <label for="image">Tải lên hình ảnh mới (nếu muốn thay đổi):</label>
                <input type="file" id="image" name="image" accept="image/*">
                <div id="image-preview" class="image-preview">
                    <img src="" alt="Preview hình ảnh mới" style="display: none;" id="image-preview-img">
                </div>
            </div>
            <div class="form-group">
                <label for="ingredients">Thành phần (phân tách bằng dấu phẩy):</label>
                <input type="text" id="ingredients" name="ingredients" placeholder="Ví dụ: Vitamin C, Kẽm">
            </div>
            <div class="form-group">
                <label for="benefits">Lợi ích (phân tách bằng dấu phẩy):</label>
                <input type="text" id="benefits" name="benefits" placeholder="Ví dụ: Tăng đề kháng, Hỗ trợ tiêu hóa">
            </div>
            <div class="form-group">
                <label for="usage_instructions">Hướng dẫn sử dụng:</label>
                <textarea id="usage_instructions" name="usage_instructions"></textarea>
            </div>
            <div class="form-group">
                <label for="warnings">Cảnh báo:</label>
                <textarea id="warnings" name="warnings"></textarea>
            </div>
            <div class="form-group">
                <label for="storage_instructions">Hướng dẫn bảo quản:</label>
                <textarea id="storage_instructions" name="storage_instructions"></textarea>
            </div>
            <div class="form-group">
                <label for="target_audience">Đối tượng sử dụng (phân tách bằng dấu phẩy):</label>
                <input type="text" id="target_audience" name="target_audience" placeholder="Ví dụ: Người lớn, Trẻ em">
            </div>
            <div class="form-group">
                <label for="certifications">Chứng nhận (phân tách bằng dấu phẩy):</label>
                <input type="text" id="certifications" name="certifications" placeholder="Ví dụ: GMP, FDA">
            </div>
            <div class="form-group">
                <label for="quantity_in_stock">Số lượng tồn kho:</label>
                <input type="number" id="quantity_in_stock" name="quantity_in_stock" min="0" required>
            </div>
            <div class="form-group">
                <label for="price">Giá:</label>
                <input type="number" id="price" name="price" min="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="currency">Tiền tệ:</label>
                <select id="currency" name="currency">
                    <option value="VND">VND</option>
                    <option value="USD">USD</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="submit">Lưu thay đổi</button>
                <button type="button" onclick="window.location.href='/pages/list-products.html'">Hủy</button>
            </div>
        </form>
    </main>

    <script>
        // Đảm bảo code nằm trong một khối để tránh lỗi cú pháp
        (function() {
            let originalProduct = null;

            // Lấy ID từ query string
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                showError('Vui lòng cung cấp ID sản phẩm');
                return;
            }

            // Lấy chi tiết sản phẩm
            fetch(`/api/products/${productId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Không tìm thấy sản phẩm');
                    return response.json();
                })
                .then(product => {
                    originalProduct = product;
                    document.getElementById('id').value = product.id || '';
                    document.getElementById('name').value = product.name || '';
                    document.getElementById('description').value = product.description || '';
                    document.getElementById('category').value = product.category || '';
                    document.getElementById('brand').value = product.brand || '';
                    document.getElementById('dosage_form').value = product.dosage_form || '';
                    // Xóa dòng lỗi: document.getElementById('image_url').value = product.image_url || '';
                    document.getElementById('ingredients').value = product.ingredients?.join(', ') || '';
                    document.getElementById('benefits').value = product.benefits?.join(', ') || '';
                    document.getElementById('usage_instructions').value = product.usage_instructions || '';
                    document.getElementById('warnings').value = product.warnings || '';
                    document.getElementById('storage_instructions').value = product.storage_instructions || '';
                    document.getElementById('target_audience').value = product.target_audience?.join(', ') || '';
                    document.getElementById('certifications').value = product.certifications?.join(', ') || '';
                    document.getElementById('quantity_in_stock').value = product.quantity_in_stock || 0;
                    document.getElementById('price').value = product.price || 0;
                    document.getElementById('currency').value = product.currency || 'VND';

                    // Hiển thị hình ảnh hiện tại
                    const currentImage = document.getElementById('current-image-img');
                    const currentImagePlaceholder = document.getElementById('current-image-placeholder');
                    const deleteCurrentImageBtn = document.getElementById('delete-current-image');
                    if (product.image_url) {
                        // Sử dụng đường dẫn tuyệt đối để đảm bảo hình ảnh tải đúng
                        const imageUrl = product.image_url.startsWith('/images/') 
                            ? `http://localhost:3000${product.image_url}` 
                            : `http://localhost:3000/images/${product.image_url}`;
                        
                        console.log('Image URL:', imageUrl); // Thêm log để kiểm tra
                        currentImage.src = imageUrl;
                        currentImage.style.display = 'block';
                        if (deleteCurrentImageBtn) deleteCurrentImageBtn.style.display = 'block';
                        currentImage.onerror = () => {
                            console.error('Failed to load image:', imageUrl); // Log lỗi
                            currentImage.style.display = 'none';
                            if (deleteCurrentImageBtn) deleteCurrentImageBtn.style.display = 'none';
                            if (currentImagePlaceholder) currentImagePlaceholder.style.display = 'block';
                            showError(`Không thể tải hình ảnh hiện tại: ${imageUrl}`);
                        };
                        currentImage.onload = () => {
                            console.log('Image loaded successfully:', imageUrl); // Log khi tải thành công
                        };
                    } else {
                        if (currentImagePlaceholder) currentImagePlaceholder.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.log('Error fetching product:', error.message);
                    showError(error.message);
                });

            // Preview hình ảnh mới
            document.getElementById('image').addEventListener('change', function(event) {
                const file = event.target.files[0];
                const previewImg = document.getElementById('image-preview-img');
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        previewImg.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                }
            });

            // Xử lý submit form
            document.getElementById('update-product-form').addEventListener('submit', async event => {
                event.preventDefault();
                clearMessages();

                const form = event.target;
                const formData = new FormData(form);

                // Validation phía client
                const name = formData.get('name');
                const quantity_in_stock = parseInt(formData.get('quantity_in_stock'));
                const price = parseFloat(formData.get('price'));

                if (!name.trim()) {
                    showError('Tên sản phẩm là bắt buộc');
                    return;
                }
                if (isNaN(quantity_in_stock) || quantity_in_stock < 0) {
                    showError('Số lượng tồn kho phải là số không âm');
                    return;
                }
                if (isNaN(price) || price <= 0) {
                    showError('Giá phải là số dương');
                    return;
                }

                // Chuẩn bị dữ liệu để kiểm tra thay đổi
                const updateData = {
                    name: name,
                    description: formData.get('description') || '',
                    category: formData.get('category') || '',
                    brand: formData.get('brand') || '',
                    dosage_form: formData.get('dosage_form') || '',
                    ingredients: formData.get('ingredients') ? formData.get('ingredients').split(',').map(item => item.trim()).filter(item => item) : [],
                    benefits: formData.get('benefits') ? formData.get('benefits').split(',').map(item => item.trim()).filter(item => item) : [],
                    usage_instructions: formData.get('usage_instructions') || '',
                    warnings: formData.get('warnings') || '',
                    storage_instructions: formData.get('storage_instructions') || '',
                    target_audience: formData.get('target_audience') ? formData.get('target_audience').split(',').map(item => item.trim()).filter(item => item) : [],
                    certifications: formData.get('certifications') ? formData.get('certifications').split(',').map(item => item.trim()).filter(item => item) : [],
                    quantity_in_stock: quantity_in_stock,
                    price: price,
                    currency: formData.get('currency') || 'VND'
                };

                // Kiểm tra thay đổi (không bao gồm image vì image được xử lý riêng)
                const isUnchanged = Object.keys(updateData).every(key => {
                    if (Array.isArray(updateData[key]) && Array.isArray(originalProduct[key])) {
                        return updateData[key].length === originalProduct[key].length &&
                            updateData[key].every((item, idx) => item === originalProduct[key][idx]);
                    }
                    return updateData[key] === originalProduct[key];
                });
                const hasImage = !!formData.get('image') && formData.get('image').size > 0;
                if (isUnchanged && !hasImage) {
                    showError('Không có thông tin nào được thay đổi');
                    return;
                }

                // Gửi yêu cầu cập nhật
                try {
                    const response = await fetch(`/api/products/${productId}`, {
                        method: 'PUT',
                        body: formData // Gửi FormData để hỗ trợ file upload
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Lỗi khi cập nhật sản phẩm');
                    }

                    const result = await response.json();
                    console.log('Update success:', result.message);
                    showSuccess(result.message);
                    setTimeout(() => window.location.href = '/pages/list-products.html', 3000);
                } catch (error) {
                    console.log('Update error:', error.message);
                    showError(error.message);
                }
            });

            // Hàm hiển thị lỗi
            function showError(message) {
                const errorDiv = document.getElementById('error-message');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    // Tự động ẩn sau 3 giây
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                    }, 3000);
                }
            }

            // Hàm hiển thị thành công
            function showSuccess(message) {
                const successDiv = document.getElementById('success-message');
                if (successDiv) {
                    successDiv.textContent = message;
                    successDiv.style.display = 'block';
                    // Tự động ẩn sau 3 giây (đồng bộ với thời gian chuyển hướng)
                    setTimeout(() => {
                        successDiv.style.display = 'none';
                    }, 3000);
                }
            }

            // Xóa thông báo
            function clearMessages() {
                const errorDiv = document.getElementById('error-message');
                const successDiv = document.getElementById('success-message');
                if (errorDiv) errorDiv.style.display = 'none';
                if (successDiv) successDiv.style.display = 'none';
            }
        })();
    </script>
</body>
</html>