<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chỉnh Sửa Sản Phẩm</title>
    <link rel="stylesheet" href="/stylesheets/update-product.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/">Trang chủ</a></li>
                <li><a href="/pages/list-products.html">Danh sách sản phẩm</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h1>Chỉnh Sửa Sản Phẩm</h1>
        <!-- Thông báo được đặt ở đây nhưng sẽ dùng position: fixed để cố định vị trí -->
        <div id="error-message" class="error" style="display: none;"></div>
        <div id="success-message" class="success" style="display: none;"></div>

        <form id="update-product-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="id">ID:</label>
                <input type="text" id="id" name="id" readonly>
            </div>
            <div class="form-group">
                <label for="name">Tên sản phẩm:</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="description">Mô tả:</label>
                <textarea id="description" name="description"></textarea>
            </div>
            <div class="form-group">
                <label for="category">Danh mục:</label>
                <select id="category" name="category">
                    <option value="">Chọn danh mục</option>
                    <option value="HTSK">HTSK</option>
                    <option value="BDN">BDN</option>
                    <option value="LĐ">LĐ</option>
                    <option value="KHOANGCHAT">KHOANGCHAT</option>
                </select>
            </div>
            <div class="form-group">
                <label for="brand">Thương hiệu:</label>
                <input type="text" id="brand" name="brand">
            </div>
            <div class="form-group">
                <label for="dosage_form">Dạng bào chế:</label>
                <input type="text" id="dosage_form" name="dosage_form">
            </div>
            <div class="form-group">
                <label>Hình ảnh hiện tại:</label>
                <div id="current-image" class="image-preview">
                    <img src="" alt="Hình ảnh hiện tại" style="display: none;" id="current-image-img">
                </div>
            </div>
            <div class="form-group">
                <label for="image">Tải lên hình ảnh mới (nếu muốn thay đổi):</label>
                <input type="file" id="image" name="image" accept="image/*">
                <div id="image-preview" class="image-preview">
                    <img src="" alt="Preview hình ảnh mới" style="display: none;" id="image-preview-img">
                </div>
            </div>
            <div class="form-group">
                <label for="ingredients">Thành phần (phân tách bằng dấu phẩy):</label>
                <input type="text" id="ingredients" name="ingredients" placeholder="Ví dụ: Vitamin C, Kẽm">
            </div>
            <div class="form-group">
                <label for="benefits">Lợi ích (phân tách bằng dấu phẩy):</label>
                <input type="text" id="benefits" name="benefits" placeholder="Ví dụ: Tăng đề kháng, Hỗ trợ tiêu hóa">
            </div>
            <div class="form-group">
                <label for="usage_instructions">Hướng dẫn sử dụng:</label>
                <textarea id="usage_instructions" name="usage_instructions"></textarea>
            </div>
            <div class="form-group">
                <label for="warnings">Cảnh báo:</label>
                <textarea id="warnings" name="warnings"></textarea>
            </div>
            <div class="form-group">
                <label for="storage_instructions">Hướng dẫn bảo quản:</label>
                <textarea id="storage_instructions" name="storage_instructions"></textarea>
            </div>
            <div class="form-group">
                <label for="target_audience">Đối tượng sử dụng (phân tách bằng dấu phẩy):</label>
                <input type="text" id="target_audience" name="target_audience" placeholder="Ví dụ: Người lớn, Trẻ em">
            </div>
            <div class="form-group">
                <label for="certifications">Chứng nhận (phân tách bằng dấu phẩy):</label>
                <input type="text" id="certifications" name="certifications" placeholder="Ví dụ: GMP, FDA">
            </div>
            <div class="form-group">
                <label for="quantity_in_stock">Số lượng tồn kho:</label>
                <input type="number" id="quantity_in_stock" name="quantity_in_stock" min="0" required>
            </div>
            <div class="form-group">
                <label for="price">Giá:</label>
                <input type="number" id="price" name="price" min="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="currency">Tiền tệ:</label>
                <select id="currency" name="currency">
                    <option value="VND">VND</option>
                    <option value="USD">USD</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="submit">Lưu thay đổi</button>
                <button type="button" onclick="window.location.href='/pages/list-products.html'">Hủy</button>
            </div>
        </form>
    </main>

    <script>
(function() {
    let originalProduct = null;

    // Lấy ID từ query string
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    if (!productId) {
        showError('Vui lòng cung cấp ID sản phẩm');
        return;
    }

    // Hàm tải chi tiết sản phẩm
    async function loadProduct() {
        try {
            const response = await fetch(`/api/products/${productId}`);
            if (!response.ok) throw new Error('Không tìm thấy sản phẩm');
            const product = await response.json();
            originalProduct = product;
            populateForm(product);
            displayCurrentImage(product.image_url);
        } catch (error) {
            console.error('Error fetching product:', error);
            showError(error.message);
        }
    }

    // Hàm điền dữ liệu vào form
    function populateForm(product) {
        document.getElementById('id').value = product.id || '';
        document.getElementById('name').value = product.name || '';
        document.getElementById('description').value = product.description || '';
        document.getElementById('category').value = product.category || '';
        document.getElementById('brand').value = product.brand || '';
        document.getElementById('dosage_form').value = product.dosage_form || '';
        document.getElementById('ingredients').value = product.ingredients?.join(', ') || '';
        document.getElementById('benefits').value = product.benefits?.join(', ') || '';
        document.getElementById('usage_instructions').value = product.usage_instructions || '';
        document.getElementById('warnings').value = product.warnings || '';
        document.getElementById('storage_instructions').value = product.storage_instructions || '';
        document.getElementById('target_audience').value = product.target_audience?.join(', ') || '';
        document.getElementById('certifications').value = product.certifications?.join(', ') || '';
        document.getElementById('quantity_in_stock').value = product.quantity_in_stock || 0;
        document.getElementById('price').value = product.price || 0;
        document.getElementById('currency').value = product.currency || 'VND';
    }

    // Hàm hiển thị hình ảnh hiện tại
    function displayCurrentImage(imageUrl) {
        const currentImage = document.getElementById('current-image-img');
        if (imageUrl) {
            const fullImageUrl = `http://localhost:3000${imageUrl}?t=${new Date().getTime()}`;
            console.log('Loading image:', fullImageUrl);
            currentImage.src = fullImageUrl;
            currentImage.style.display = 'block';
            currentImage.onerror = () => {
                console.error('Failed to load image:', fullImageUrl);
                currentImage.style.display = 'none';
                showError('Không thể tải hình ảnh hiện tại');
            };
        } else {
            currentImage.style.display = 'none';
        }
    }

    // Preview hình ảnh mới
    document.getElementById('image').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const previewImg = document.getElementById('image-preview-img');
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewImg.src = '';
            previewImg.style.display = 'none';
        }
    });

    // Xử lý submit form
    document.getElementById('update-product-form').addEventListener('submit', async event => {
        event.preventDefault();
        clearMessages();

        if (!confirm('Bạn có chắc chắn muốn cập nhật sản phẩm này?')) {
            return;
        }

        const form = event.target;
        const formData = new FormData(form);

        // Validation phía client
        const name = formData.get('name');
        const quantity_in_stock = parseInt(formData.get('quantity_in_stock'));
        const price = parseFloat(formData.get('price'));

        if (!name.trim()) {
            showError('Tên sản phẩm là bắt buộc');
            return;
        }
        if (isNaN(quantity_in_stock) || quantity_in_stock < 0) {
            showError('Số lượng tồn kho phải là số không âm');
            return;
        }
        if (isNaN(price) || price <= 0) {
            showError('Giá phải là số dương');
            return;
        }

        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'PUT',
                body: formData
            });

            const result = await response.json();
            if (!response.ok) {
                const errorMessage = result.details ? result.details.join(', ') : result.error || 'Lỗi khi cập nhật sản phẩm';
                showError(errorMessage);
                return;
            }

            console.log('Update success:', result.message);
            showSuccess(result.message || 'Cập nhật sản phẩm thành công');
            setTimeout(() => window.location.href = '/pages/list-products.html', 3000);
        } catch (error) {
            console.error('Update error:', error);
            showError('Đã xảy ra lỗi: ' + error.message);
        }
    });

    // Hàm hiển thị lỗi
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 3000);
        }
    }

    // Hàm hiển thị thành công
    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        if (successDiv) {
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }
    }

    // Xóa thông báo
    function clearMessages() {
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        if (errorDiv) errorDiv.style.display = 'none';
        if (successDiv) successDiv.style.display = 'none';
    }

    // Tải sản phẩm khi trang được load
    loadProduct();
})();
</script>
</body>
</html>